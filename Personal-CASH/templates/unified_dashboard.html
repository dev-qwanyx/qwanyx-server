{% extends "base.html" %}

{% block content %}
<style>
    .transaction-row { cursor: pointer; }
    .transaction-row:hover { background-color: #f8f9fa; }
    .type-payable { color: #e74c3c; }
    .type-receivable { color: #27ae60; }
    .quick-add-form { 
        display: none; 
        background: white; 
        padding: 20px; 
        border-radius: 5px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        position: relative;
        z-index: 100;
    }
    .editable { 
        cursor: pointer; 
        padding: 2px 5px; 
        border-radius: 3px; 
        position: relative;
    }
    .editable:hover { 
        background-color: #ecf0f1; 
        text-decoration: underline dotted;
    }
    .editable.editing {
        background-color: #fff3cd;
    }
    .drag-handle {
        cursor: move;
        color: #95a5a6;
        padding: 0 10px;
        font-size: 20px;
    }
    .drag-handle:hover {
        color: #3498db;
    }
    .sortable-ghost {
        opacity: 0.4;
        background-color: #ecf0f1;
    }
    .sortable-drag {
        background-color: #fff;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
</style>

<!-- Summary Stats -->
<div class="stats">
    <div class="stat-box danger">
        <h2>${{ "%.2f"|format(remaining_payables) }}</h2>
        <p>Total to Pay</p>
        <small>{{ pending_payables_count }} pending</small>
    </div>
    <div class="stat-box success">
        <h2>${{ "%.2f"|format(remaining_receivables) }}</h2>
        <p>Total to Receive</p>
        <small>{{ pending_receivables_count }} pending</small>
    </div>
    <div class="stat-box {% if net_position >= 0 %}success{% else %}danger{% endif %}">
        <h2>${{ "%.2f"|format(net_position) }}</h2>
        <p>Net Position</p>
        <small>{% if completed_balance != 0 %}Balance: €{{ "%.2f"|format(completed_balance) }}{% endif %}</small>
    </div>
    <div class="stat-box" style="background-color: #9b59b6;">
        <h2>${{ "%.2f"|format(current_balance) }}</h2>
        <p>Current Balance</p>
        <small>After completed transactions</small>
    </div>
</div>

<!-- Cash Flow Projection Graph -->
<div class="card" style="background: #f8f9fa; margin-bottom: 20px;">
    <h3>Cash Flow Projection</h3>
    <div style="height: 300px;">
        <canvas id="cashFlowChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
// Form handling functions - defined globally
function toggleQuickAdd() {
    console.log('toggleQuickAdd called');
    const form = document.getElementById('quickAddForm');
    if (!form) {
        alert('Form not found!');
        return;
    }
    
    // Toggle visibility
    const currentDisplay = form.style.display;
    console.log('Current display:', currentDisplay);
    
    if (currentDisplay === 'block') {
        form.style.display = 'none';
    } else {
        form.style.display = 'block';
        resetAddForm();
    }
    
    console.log('New display:', form.style.display);
}

function resetAddForm() {
    const form = document.getElementById('quickAddForm');
    const formElement = form.querySelector('form');
    
    // Reset form
    formElement.reset();
    
    // Reset title
    form.querySelector('h3').textContent = 'Quick Add Transaction';
    
    // Reset submit handler
    formElement.removeAttribute('data-edit-id');
    formElement.onsubmit = addTransaction;
    
    // Reset button text
    formElement.querySelector('button[type="submit"]').textContent = 'Add';
    
    // DO NOT hide form here - let toggleQuickAdd handle visibility
    
    // Reset counterparty field visibility
    document.querySelector('input[name="new_counterparty_name"]').style.display = 'none';
    
    // Hide recurring fields
    document.getElementById('recurringFields').style.display = 'none';
    
    // Update form labels
    updateFormLabels();
}

function updateFormLabels() {
    const type = document.querySelector('select[name="type"]').value;
    const label = document.getElementById('counterpartyLabel');
    const vatField = document.getElementById('vatField');
    
    label.textContent = type === 'payable' ? 'Pay To:' : 'Receive From:';
    // Show VAT field for both payables and receivables
    vatField.style.display = 'block';
}

function toggleRecurring(isChecked) {
    document.getElementById('recurringFields').style.display = isChecked ? 'block' : 'none';
}

function updateTotalWithVAT() {
    const amount = parseFloat(document.querySelector('input[name="amount"]').value) || 0;
    const vatPercentage = parseFloat(document.querySelector('select[name="vat_percentage"]').value) || 0;
    const vatAmount = amount * (vatPercentage / 100);
    const total = amount + vatAmount;
    
    const display = document.getElementById('totalWithVAT');
    if (vatPercentage > 0 && amount > 0) {
        display.innerHTML = `Total with VAT: €${total.toFixed(2)} (€${amount.toFixed(2)} + €${vatAmount.toFixed(2)} VAT)`;
    } else {
        display.innerHTML = '';
    }
}

function toggleCommunicationType(type) {
    const freeField = document.getElementById('freeCommunicationField');
    const structuredField = document.getElementById('structuredCommunicationField');
    
    if (type === 'structured') {
        freeField.style.display = 'none';
        structuredField.style.display = 'block';
        // Clear free communication when switching
        document.querySelector('input[name="free_communication"]').value = '';
    } else {
        freeField.style.display = 'block';
        structuredField.style.display = 'none';
        // Clear structured communication when switching
        document.querySelector('input[name="structured_communication"]').value = '';
    }
}

function formatStructuredComm(input) {
    // Remove all non-digits
    let value = input.value.replace(/\D/g, '');
    
    // Limit to 12 digits
    value = value.substring(0, 12);
    
    // Format as XXX/XXXX/XXXXX
    let formatted = '';
    if (value.length > 0) {
        formatted = value.substring(0, 3);
        if (value.length > 3) {
            formatted += '/' + value.substring(3, 7);
        }
        if (value.length > 7) {
            formatted += '/' + value.substring(7, 12);
        }
    }
    
    // Add +++ markers if there's content
    if (formatted) {
        formatted = '+++' + formatted + '+++';
    }
    
    // Validate mod97 check if we have 12 digits
    if (value.length === 12) {
        const checkDigits = value.substring(10, 12);
        const baseNumber = value.substring(0, 10);
        const expectedCheck = (parseInt(baseNumber) % 97).toString().padStart(2, '0');
        
        if (checkDigits !== expectedCheck) {
            input.style.borderColor = '#e74c3c';
            input.title = 'Invalid check digits (should be ' + expectedCheck + ')';
        } else {
            input.style.borderColor = '#27ae60';
            input.title = 'Valid structured communication';
        }
    } else {
        input.style.borderColor = '';
        input.title = '';
    }
    
    input.value = formatted;
}

function formatBankAccount(input) {
    // Remove all non-alphanumeric characters
    let value = input.value.replace(/[^A-Z0-9]/gi, '').toUpperCase();
    
    // Belgian IBAN format: BE + 2 check digits + 12 digits
    if (value.startsWith('BE') && value.length > 2) {
        // Format as BEXX XXXX XXXX XXXX
        let formatted = value.substring(0, 4);
        for (let i = 4; i < value.length && i < 16; i += 4) {
            formatted += ' ' + value.substring(i, i + 4);
        }
        input.value = formatted.trim();
    } else {
        input.value = value;
    }
}

function setToday() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const formattedDate = `${yyyy}-${mm}-${dd}`;
    
    document.querySelector('input[name="due_date"]').value = formattedDate;
}

function addTransaction(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    // Handle new counterparty
    const counterpartySelect = document.querySelector('select[name="counterparty_id"]');
    if (counterpartySelect.value === 'new') {
        const newNameInput = document.querySelector('input[name="new_counterparty_name"]');
        if (!newNameInput.value) {
            alert('Please enter a name for the new counterparty');
            return;
        }
    }
    
    fetch('/add_transaction', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        console.log('Add transaction result:', result);
        if (result.success) {
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding transaction: ' + error.message);
    });
}
</script>

<script>
// Calculate cash flow data
let currentBalance = {{ current_balance }};
console.log('Starting balance:', currentBalance);

// Prepare transaction data - already in user's preferred order
const transactionData = [
    {% for trans in transactions %}
    {
        id: {{ trans.id }},
        type: '{{ trans.type }}',
        status: '{{ trans.status }}',
        due_date: {% if trans.due_date %}'{{ trans.due_date.isoformat() }}'{% else %}null{% endif %},
        amount: {{ trans.amount }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

console.log('Using manual transaction order for cash flow');
console.log(`Total transactions: ${transactionData.length}`);

// Calculate cash flow based on the manual order
const cashFlowPoints = [];
let runningBalance = currentBalance;

// Add starting point
const today = new Date();
cashFlowPoints.push({date: today, balance: currentBalance});

// Process transactions in the order they appear (user's manual order)
let lastDate = today;
transactionData.forEach((trans, index) => {
    if (trans.type === 'payable') {
        runningBalance -= trans.amount;
    } else if (trans.type === 'receivable') {
        runningBalance += trans.amount;
    }
    
    // Use due date if available, otherwise use a progressive date
    let transDate = trans.due_date ? new Date(trans.due_date) : new Date(lastDate);
    
    // For cash flow purposes, ensure dates are progressive based on order
    if (transDate <= lastDate) {
        transDate = new Date(lastDate);
        transDate.setDate(transDate.getDate() + 1);
    }
    
    cashFlowPoints.push({
        date: transDate,
        balance: runningBalance
    });
    
    lastDate = transDate;
    
    console.log(`Position ${index + 1}: ${trans.type} €${trans.amount} -> Balance: €${runningBalance}`);
});

// Create monthly snapshots of cash position
const monthlyBalance = [];
const monthlyLabels = [];

for (let i = 0; i <= 12; i++) {
    const monthDate = new Date(today);
    monthDate.setMonth(today.getMonth() + i);
    monthDate.setDate(15); // Middle of month
    
    // Find the cash position at this date based on our ordered transactions
    let balanceAtDate = currentBalance;
    for (let point of cashFlowPoints) {
        if (point.date <= monthDate) {
            balanceAtDate = point.balance;
        } else {
            break;
        }
    }
    
    const label = i === 0 ? 'Now' : monthDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    monthlyLabels.push(label);
    monthlyBalance.push(Math.round(balanceAtDate));
}

const labels = monthlyLabels;

// Register the datalabels plugin
Chart.register(ChartDataLabels);

// Create the chart
const ctx = document.getElementById('cashFlowChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: 'Cash Balance',
            data: monthlyBalance,
            backgroundColor: monthlyBalance.map(value => value >= 0 ? 'rgba(39, 174, 96, 0.8)' : 'rgba(231, 76, 60, 0.8)'),
            borderColor: monthlyBalance.map(value => value >= 0 ? '#27ae60' : '#e74c3c'),
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return '€' + context.parsed.y.toLocaleString();
                    }
                }
            },
            datalabels: {
                display: true,
                color: function(context) {
                    return context.dataset.data[context.dataIndex] >= 0 ? '#27ae60' : '#e74c3c';
                },
                font: {
                    weight: 'bold',
                    size: 12
                },
                formatter: function(value) {
                    return '€' + value.toLocaleString();
                },
                anchor: 'end',
                align: 'top',
                offset: 5
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                grid: {
                    color: function(context) {
                        if (context.tick.value === 0) {
                            return '#333';
                        }
                        return 'rgba(0, 0, 0, 0.05)';
                    },
                    lineWidth: function(context) {
                        if (context.tick.value === 0) {
                            return 3;
                        }
                        return 1;
                    }
                },
                ticks: {
                    display: false
                }
            }
        }
    }
});
</script>

<!-- Quick Add Section -->
<div class="card">
    <button onclick="toggleQuickAdd()" class="btn btn-success" style="margin-bottom: 15px;">+ Add Transaction</button>
    
    <div id="quickAddForm" class="quick-add-form" style="display: none;">
        <h3>Quick Add Transaction</h3>
        <form onsubmit="addTransaction(event)">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>Type:</label>
                    <select name="type" onchange="updateFormLabels()" required>
                        <option value="payable">Payable (Money Out)</option>
                        <option value="receivable">Receivable (Money In)</option>
                    </select>
                </div>
                <div>
                    <label id="counterpartyLabel">Pay To:</label>
                    <select name="counterparty_id" required>
                        <option value="">Select...</option>
                        {% for creditor in creditors %}
                        <option value="{{ creditor.id }}">{{ creditor.name }}</option>
                        {% endfor %}
                        <option value="new">+ Add New</option>
                    </select>
                    <input type="text" name="new_counterparty_name" placeholder="New name" style="display: none; margin-top: 5px;">
                </div>
                <div>
                    <label>Amount (excl. VAT):</label>
                    <input type="number" name="amount" step="0.01" required onchange="updateTotalWithVAT()">
                </div>
                <div>
                    <label>Due Date:</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="date" name="due_date" style="flex: 1;">
                        <button type="button" onclick="setToday()" class="btn" style="padding: 5px 10px; font-size: 12px;">Today</button>
                    </div>
                </div>
                <div id="vatField" style="display: none;">
                    <label>VAT %:</label>
                    <select name="vat_percentage" onchange="updateTotalWithVAT()">
                        <option value="0" selected>No VAT</option>
                        <option value="21">21% (Standard rate)</option>
                        <option value="6">6% (Reduced rate)</option>
                        <option value="12">12% (Intermediate rate)</option>
                    </select>
                    <div style="margin-top: 5px; font-weight: bold;" id="totalWithVAT"></div>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label>
                        <input type="checkbox" name="is_recurring" onchange="toggleRecurring(this.checked)">
                        Recurring Transaction
                    </label>
                </div>
                <div id="recurringFields" style="display: none; grid-column: 1 / -1; background: #f0f0f0; padding: 10px; border-radius: 5px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div>
                            <label>Frequency:</label>
                            <select name="recurring_frequency">
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div>
                            <label>Day of Month:</label>
                            <input type="number" name="recurring_day" min="1" max="31" value="1">
                        </div>
                        <div>
                            <label>Number of Times:</label>
                            <input type="number" name="recurring_count" min="1" max="60" value="12" required>
                        </div>
                    </div>
                </div>
                <div>
                    <label>Bank Account:</label>
                    <div style="display: flex; gap: 5px; position: relative;">
                        <input type="text" name="bank_account" placeholder="BE12 3456 7890 1234" oninput="formatBankAccount(this)" maxlength="19" style="flex: 1;">
                        <button type="button" id="accountDropdownBtn" onclick="toggleAccountDropdown()" class="btn" style="padding: 5px 10px; display: none;" title="Select from previous accounts">▼</button>
                        <div id="accountDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 40px; background: white; border: 1px solid #ddd; border-radius: 3px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1000; max-height: 150px; overflow-y: auto;">
                            <!-- Account options will be inserted here -->
                        </div>
                    </div>
                </div>
                <div>
                    <label>Communication Type:</label>
                    <select name="communication_type" onchange="toggleCommunicationType(this.value)">
                        <option value="structured">Structured Communication</option>
                        <option value="free">Free Communication</option>
                    </select>
                </div>
                <div id="freeCommunicationField" style="display: none;">
                    <label>Free Communication:</label>
                    <input type="text" name="free_communication" placeholder="Invoice 2024-001, Order ref: ABC123">
                </div>
                <div id="structuredCommunicationField" style="display: block;">
                    <label>Structured Communication:</label>
                    <input type="text" name="structured_communication" placeholder="+++123/4567/89012+++" oninput="formatStructuredComm(this)" maxlength="20">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label>Description:</label>
                    <input type="text" name="description" placeholder="Optional description">
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button type="submit" class="btn btn-success">Add</button>
                <button type="button" onclick="document.getElementById('quickAddForm').style.display = 'none';" class="btn btn-danger">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Transactions Table -->
<div class="card">
    <h2>All Transactions</h2>
    
    <!-- Filters -->
    <div style="margin-bottom: 15px;">
        <select id="filterType" onchange="filterTransactions()">
            <option value="all">All Types</option>
            <option value="payable">Payables Only</option>
            <option value="receivable">Receivables Only</option>
        </select>
        <select id="filterStatus" onchange="filterTransactions()">
            <option value="all">All Status</option>
            <option value="pending">Pending</option>
            <option value="completed">Completed</option>
        </select>
    </div>
    
    <table id="transactionsTable">
        <thead>
            <tr>
                <th style="width: 30px;"></th>
                <th>Type</th>
                <th>Counterparty</th>
                <th>Amount</th>
                <th>Remaining</th>
                <th>Due Date</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="sortableTransactions">
            {% for trans in transactions %}
            <tr class="transaction-row" 
                data-id="{{ trans.id }}" 
                data-type="{{ trans.type }}" 
                data-status="{{ trans.status }}">
                <td class="drag-handle">≡</td>
                <td>
                    <span class="type-{{ trans.type }}">
                        {{ trans.type|upper }}
                    </span>
                </td>
                <td class="editable" data-field="counterparty_name" data-trans-id="{{ trans.id }}">
                    {{ trans.counterparty_name }}
                    {% if trans.is_recurring %}
                        <span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">RECURRING</span>
                    {% elif trans.recurring_parent_id %}
                        <span style="background: #95a5a6; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">AUTO</span>
                    {% endif %}
                    {% if trans.vat_percentage > 0 %}
                        <small style="color: #7f8c8d;">(VAT {{ trans.vat_percentage }}%)</small>
                    {% endif %}
                    {% if trans.structured_communication %}
                        <br><small style="color: #3498db;">{{ trans.structured_communication }}</small>
                    {% elif trans.free_communication %}
                        <br><small style="color: #27ae60;">{{ trans.free_communication }}</small>
                    {% endif %}
                    {% if trans.bank_account %}
                        <br><small style="color: #95a5a6;">{{ trans.bank_account }}</small>
                    {% endif %}
                </td>
                <td class="editable" data-field="amount" data-trans-id="{{ trans.id }}" data-vat="{{ trans.vat_percentage }}">
                    ${{ "%.2f"|format(trans.amount) }}
                </td>
                <td>${{ "%.2f"|format(trans.remaining_amount) }}</td>
                <td class="editable" data-field="due_date" data-trans-id="{{ trans.id }}">
                    {% if trans.due_date %}
                        {% set days = (trans.due_date - datetime.now()).days %}
                        <span style="color: {% if days < 0 %}red{% elif days < 7 %}orange{% else %}green{% endif %}">
                            {{ trans.due_date.strftime('%Y-%m-%d') }}
                        </span>
                    {% else %}
                        <span style="color: #999;">No date</span>
                    {% endif %}
                </td>
                <td>
                    {% if trans.type == 'payable' %}
                        <input type="checkbox" 
                               {% if trans.priority_payment %}checked{% endif %}
                               onchange="updatePriority({{ trans.id }}, this.checked)"
                               title="Pay immediately when funds arrive">
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if trans.is_completed %}
                        <span class="status-paid">COMPLETED</span>
                    {% else %}
                        <span class="status-pending">PENDING</span>
                    {% endif %}
                </td>
                <td>
                    <button onclick="editTransaction({{ trans.id }})" 
                            class="btn" style="font-size: 11px; padding: 3px 8px;">
                        Edit
                    </button>
                    {% if not trans.is_completed %}
                        {% if trans.type == 'payable' %}
                            <button onclick="recordPayment({{ trans.id }}, {{ trans.remaining_amount }})" 
                                    class="btn btn-success" style="font-size: 11px; padding: 3px 8px;">
                                Pay
                            </button>
                            {% if trans.bank_account %}
                            <button onclick="showQRCode({{ trans.id }})" 
                                    class="btn" style="font-size: 11px; padding: 3px 8px; background: #8b5cf6; color: white;"
                                    title="Generate QR code for payment">
                                QR
                            </button>
                            {% endif %}
                        {% else %}
                            <button onclick="recordReceipt({{ trans.id }}, {{ trans.remaining_amount }})" 
                                    class="btn btn-success" style="font-size: 11px; padding: 3px 8px;">
                                Receive
                            </button>
                        {% endif %}
                    {% endif %}
                    <button onclick="deleteTransaction({{ trans.id }})" 
                            class="btn btn-danger" style="font-size: 11px; padding: 3px 8px;">
                        Del
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Cash Flow Projection -->
<div class="card" style="margin-top: 20px;">
    <h3>Cash Flow Projection</h3>
    <div id="cashFlowProjection">
        <!-- This would show upcoming receivables and how they can cover payables -->
    </div>
</div>

<!-- QR Code Modal -->
<div id="qrModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; background: white; margin: 50px auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 10px;">
        <button onclick="closeQRModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        <h2 style="text-align: center; margin-bottom: 20px;">Payment QR Code</h2>
        <div id="qrContent" style="text-align: center;">
            <!-- QR code will be inserted here -->
        </div>
        <div id="qrDetails" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
            <!-- Payment details will be shown here -->
        </div>
        <p style="text-align: center; margin-top: 20px; color: #7f8c8d; font-size: 14px;">
            Scan this QR code with your banking app to make the payment
        </p>
    </div>
</div>

<script>
// Show/hide new counterparty name field
document.querySelector('select[name="counterparty_id"]').addEventListener('change', function() {
    const newNameInput = document.querySelector('input[name="new_counterparty_name"]');
    newNameInput.style.display = this.value === 'new' ? 'block' : 'none';
    if (this.value === 'new') {
        newNameInput.required = true;
    } else {
        newNameInput.required = false;
        newNameInput.value = '';
    }
    
    // Load bank accounts for selected counterparty
    if (this.value && this.value !== 'new') {
        loadBankAccountsForCounterparty(this.value);
    } else {
        document.getElementById('accountDropdownBtn').style.display = 'none';
    }
});

function loadBankAccountsForCounterparty(counterpartyId) {
    fetch(`/get_bank_accounts_for_counterparty/${counterpartyId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.bank_accounts.length > 0) {
                const dropdown = document.getElementById('accountDropdown');
                const btn = document.getElementById('accountDropdownBtn');
                
                // Build dropdown content
                dropdown.innerHTML = data.bank_accounts.map(account => 
                    `<div style="padding: 8px; cursor: pointer; hover: background: #f5f5f5;" 
                          onclick="selectBankAccount('${account}')" 
                          onmouseover="this.style.background='#f5f5f5'" 
                          onmouseout="this.style.background='white'">
                        ${account}
                    </div>`
                ).join('');
                
                // Show dropdown button
                btn.style.display = 'block';
            } else {
                document.getElementById('accountDropdownBtn').style.display = 'none';
            }
        });
}

function toggleAccountDropdown() {
    const dropdown = document.getElementById('accountDropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function selectBankAccount(account) {
    document.querySelector('input[name="bank_account"]').value = account;
    document.getElementById('accountDropdown').style.display = 'none';
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('#accountDropdownBtn') && !e.target.closest('#accountDropdown')) {
        document.getElementById('accountDropdown').style.display = 'none';
    }
});

function filterTransactions() {
    const typeFilter = document.getElementById('filterType').value;
    const statusFilter = document.getElementById('filterStatus').value;
    
    const rows = document.querySelectorAll('.transaction-row');
    rows.forEach(row => {
        const type = row.getAttribute('data-type');
        const status = row.getAttribute('data-status');
        
        let show = true;
        if (typeFilter !== 'all' && type !== typeFilter) show = false;
        if (statusFilter !== 'all' && status !== statusFilter) show = false;
        
        row.style.display = show ? '' : 'none';
    });
}

function recordPayment(transId, amount) {
    if (confirm(`Mark as paid: $${amount}?`)) {
        fetch('/mark_transaction_complete/' + transId, {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function recordReceipt(transId, amount) {
    if (confirm(`Mark as received: $${amount}?`)) {
        fetch('/mark_transaction_complete/' + transId, {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function editTransaction(transId) {
    // Fetch transaction details and populate the form
    fetch('/get_transaction/' + transId)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const trans = data.transaction;
            
            // Show the form
            document.getElementById('quickAddForm').style.display = 'block';
            
            // Update form title
            document.querySelector('#quickAddForm h3').textContent = 'Edit Transaction';
            
            // Populate form fields
            document.querySelector('select[name="type"]').value = trans.type;
            updateFormLabels();
            
            // Handle counterparty
            const counterpartySelect = document.querySelector('select[name="counterparty_id"]');
            let optionExists = false;
            for (let option of counterpartySelect.options) {
                if (option.text === trans.counterparty_name && option.value !== 'new') {
                    counterpartySelect.value = option.value;
                    optionExists = true;
                    break;
                }
            }
            if (!optionExists) {
                // Add the counterparty as a new option temporarily
                const newOption = new Option(trans.counterparty_name, trans.counterparty_id || 'temp_' + trans.counterparty_name);
                counterpartySelect.add(newOption);
                counterpartySelect.value = newOption.value;
            }
            
            // Set amount (net amount if VAT exists)
            const amountInput = document.querySelector('input[name="amount"]');
            if (trans.vat_percentage > 0) {
                const netAmount = trans.amount / (1 + trans.vat_percentage / 100);
                amountInput.value = netAmount.toFixed(2);
            } else {
                amountInput.value = trans.amount;
            }
            
            // Set other fields
            if (trans.due_date) {
                document.querySelector('input[name="due_date"]').value = trans.due_date;
            }
            document.querySelector('select[name="vat_percentage"]').value = trans.vat_percentage || 0;
            document.querySelector('input[name="is_recurring"]').checked = trans.is_recurring;
            toggleRecurring(trans.is_recurring);
            
            if (trans.is_recurring) {
                document.querySelector('select[name="recurring_frequency"]').value = trans.recurring_frequency || 'monthly';
                document.querySelector('input[name="recurring_day"]').value = trans.recurring_day || 1;
            }
            
            document.querySelector('input[name="description"]').value = trans.description || '';
            document.querySelector('input[name="bank_account"]').value = trans.bank_account || '';
            
            // Handle communication type
            if (trans.structured_communication) {
                document.querySelector('select[name="communication_type"]').value = 'structured';
                toggleCommunicationType('structured');
                document.querySelector('input[name="structured_communication"]').value = trans.structured_communication;
            } else {
                document.querySelector('select[name="communication_type"]').value = 'free';
                toggleCommunicationType('free');
                document.querySelector('input[name="free_communication"]').value = trans.free_communication || '';
            }
            
            // Update total with VAT display
            updateTotalWithVAT();
            
            // Load bank accounts for this counterparty
            if (trans.counterparty_id) {
                loadBankAccountsForCounterparty(trans.counterparty_id);
            }
            
            // Change form submission to update instead of add
            const form = document.querySelector('#quickAddForm form');
            form.setAttribute('data-edit-id', transId);
            form.onsubmit = function(event) {
                updateTransaction(event, transId);
            };
            
            // Update button text
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Update';
        } else {
            alert('Error loading transaction: ' + data.error);
        }
    });
}

function updateTransaction(event, transId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    data.transaction_id = transId;
    
    fetch('/update_transaction', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    });
}

function deleteTransaction(transId) {
    if (confirm('Delete this transaction?')) {
        fetch('/delete_transaction/' + transId, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function updatePlannedDate(transId, date) {
    fetch('/update_transaction_field', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            transaction_id: transId,
            field: 'planned_pay_date',
            value: date
        })
    })
    .then(response => response.json())
    .then(result => {
        if (!result.success) {
            alert('Error updating planned date: ' + result.error);
        }
    });
}

function updatePriority(transId, priority) {
    fetch('/update_transaction_field', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            transaction_id: transId,
            field: 'priority_payment',
            value: priority
        })
    })
    .then(response => response.json())
    .then(result => {
        if (!result.success) {
            alert('Error updating priority: ' + result.error);
        }
    });
}

// Make cells editable
document.querySelectorAll('.editable').forEach(cell => {
    cell.addEventListener('click', function() {
        makeEditable(this);
    });
});

function makeEditable(element) {
    if (element.classList.contains('editing')) return;
    
    element.classList.add('editing');
    const field = element.getAttribute('data-field');
    const transId = element.getAttribute('data-trans-id');
    const currentValue = element.textContent.replace('$', '').trim();
    
    let input;
    if (field === 'amount') {
        input = document.createElement('input');
        input.type = 'number';
        input.step = '0.01';
        // If has VAT, show net amount for editing
        const vatPercentage = parseFloat(element.getAttribute('data-vat')) || 0;
        if (vatPercentage > 0) {
            const grossAmount = parseFloat(currentValue);
            const netAmount = grossAmount / (1 + vatPercentage / 100);
            input.value = netAmount.toFixed(2);
            // Add a note
            const note = document.createElement('div');
            note.style.fontSize = '11px';
            note.style.color = '#666';
            note.innerHTML = `Enter net amount (VAT ${vatPercentage}% will be added)`;
            element.innerHTML = '';
            element.appendChild(input);
            element.appendChild(note);
            input.focus();
            input.select();
        } else {
            input.value = currentValue;
        }
    } else if (field === 'due_date') {
        input = document.createElement('input');
        input.type = 'date';
        const dateMatch = currentValue.match(/\d{4}-\d{2}-\d{2}/);
        input.value = dateMatch ? dateMatch[0] : '';
    } else {
        input = document.createElement('input');
        input.type = 'text';
        input.value = currentValue;
    }
    
    input.style.width = '100%';
    const originalHTML = element.innerHTML;
    
    // Only add input if not already added (for amount with VAT case)
    if (field !== 'amount' || !element.querySelector('input')) {
        element.innerHTML = '';
        element.appendChild(input);
        input.focus();
        input.select();
    }
    
    const saveEdit = () => {
        let newValue = input.value;
        
        // If editing amount with VAT, calculate gross amount
        if (field === 'amount') {
            const vatPercentage = parseFloat(element.getAttribute('data-vat')) || 0;
            if (vatPercentage > 0) {
                const netAmount = parseFloat(newValue);
                const vatAmount = netAmount * (vatPercentage / 100);
                newValue = (netAmount + vatAmount).toFixed(2);
            }
        }
        
        fetch('/update_transaction_field', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                transaction_id: transId,
                field: field,
                value: newValue
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload(); // Reload to update all calculated values
            } else {
                alert('Error: ' + result.error);
                element.innerHTML = originalHTML;
            }
            element.classList.remove('editing');
        });
    };
    
    input.addEventListener('blur', saveEdit);
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit();
        }
    });
}

function showQRCode(transId) {
    // Show loading state
    const modal = document.getElementById('qrModal');
    const content = document.getElementById('qrContent');
    const details = document.getElementById('qrDetails');
    
    modal.style.display = 'block';
    content.innerHTML = '<p>Generating QR code...</p>';
    details.innerHTML = '';
    
    // Fetch QR code from server
    fetch(`/generate_qr_code/${transId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display QR code
                content.innerHTML = `<img src="${data.qr_image}" alt="Payment QR Code" style="max-width: 300px;">`;
                
                // Display payment details
                details.innerHTML = `
                    <h4 style="margin-top: 0;">Payment Details</h4>
                    <p><strong>To:</strong> ${data.transaction.counterparty}</p>
                    <p><strong>Amount:</strong> €${data.transaction.amount.toFixed(2)}</p>
                    <p><strong>Account:</strong> ${data.transaction.bank_account}</p>
                    <p><strong>Communication:</strong> ${data.transaction.communication || 'None'}</p>
                `;
            } else {
                content.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
            }
        })
        .catch(error => {
            content.innerHTML = `<p style="color: red;">Error generating QR code: ${error.message}</p>`;
        });
}

function closeQRModal() {
    document.getElementById('qrModal').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('qrModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeQRModal();
    }
});

// Initialize drag and drop
const sortable = Sortable.create(document.getElementById('sortableTransactions'), {
    handle: '.drag-handle',
    animation: 150,
    ghostClass: 'sortable-ghost',
    dragClass: 'sortable-drag',
    onEnd: function(evt) {
        // Get all transaction IDs in new order
        const rows = document.querySelectorAll('#sortableTransactions tr');
        const newOrder = [];
        rows.forEach((row, index) => {
            const transId = row.getAttribute('data-id');
            if (transId) {
                newOrder.push({
                    id: parseInt(transId),
                    order: index
                });
            }
        });
        
        // Save new order to server
        console.log('Saving new order...');
        fetch('/update_transaction_order', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({order: newOrder})
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                console.log('Order saved successfully');
                // Recalculate cash flow with new order
                setTimeout(() => location.reload(), 100);
            } else {
                console.error('Error saving order:', result.error);
            }
        });
    }
});

</script>
{% endblock %}